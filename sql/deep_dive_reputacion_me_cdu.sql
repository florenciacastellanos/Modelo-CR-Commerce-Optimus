-- Deep Dive: Reputación ME - Por CDU (Sub-causas)
-- Análisis Nov vs Dic 2025

WITH BASE_FILTERED AS (
    SELECT
        C.CAS_CASE_ID,
        CASE 
            WHEN C.CONTACT_DATE_ID BETWEEN '2025-11-01' AND '2025-11-30' THEN 'P1'
            WHEN C.CONTACT_DATE_ID BETWEEN '2025-12-01' AND '2025-12-31' THEN 'P2'
        END as PERIODO,
        COALESCE(C.CDU, 'Sin CDU') as CDU
    FROM `meli-bi-data.WHOWNER.BT_CX_CONTACTS` C
    WHERE C.SIT_SITE_ID = 'MLB'
        AND C.CONTACT_DATE_ID BETWEEN '2025-11-01' AND '2025-12-31'
        AND C.PROCESS_NAME = 'Reputación ME'
        AND C.FLAG_EXCLUDE_NUMERATOR_CR = 0
        AND C.QUE_QUEUE_ID NOT IN (2131, 230, 1102, 1241, 2075, 2294, 2295)
        AND C.PROCESS_ID NOT IN (1312)
        AND COALESCE(C.CI_REASON_ID, 0) NOT IN (2592, 6588, 10068, 2701, 10048)
)
SELECT
    CDU,
    SUM(CASE WHEN PERIODO = 'P1' THEN 1 ELSE 0 END) as CASOS_NOV,
    SUM(CASE WHEN PERIODO = 'P2' THEN 1 ELSE 0 END) as CASOS_DIC,
    SUM(CASE WHEN PERIODO = 'P2' THEN 1 ELSE 0 END) - SUM(CASE WHEN PERIODO = 'P1' THEN 1 ELSE 0 END) as VAR_CASOS
FROM BASE_FILTERED
GROUP BY CDU
ORDER BY ABS(SUM(CASE WHEN PERIODO = 'P2' THEN 1 ELSE 0 END) - SUM(CASE WHEN PERIODO = 'P1' THEN 1 ELSE 0 END)) DESC
LIMIT 20
