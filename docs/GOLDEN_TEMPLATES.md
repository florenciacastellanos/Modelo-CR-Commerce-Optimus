# ğŸŒŸ Golden Template Universal - Modelo Oficial v6.3.4

**VersiÃ³n:** 6.3.4  
**Fecha:** Febrero 2026  
**Status:** âœ… OFICIAL - ÃšNICO TEMPLATE ACTIVO

---

## ğŸ” AnÃ¡lisis Comparativo de Patrones (v6.3.4)

### **Â¿QuÃ© es?**

La secciÃ³n **"AnÃ¡lisis Comparativo de Patrones por PerÃ­odo"** es el nÃºcleo del anÃ¡lisis cualitativo en v6.3.4. Integra en una sola secciÃ³n:
- âœ… ComparaciÃ³n temporal de causas raÃ­z (Nov vs Dic)
- âœ… Sentimiento por causa y perÃ­odo
- âœ… Evidencia cualitativa con fechas
- âœ… Insights sobre quÃ© cambiÃ³ y por quÃ©

### **Estructura de la Tabla Comparativa**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PatrÃ³n / Causa RaÃ­z â”‚  Nov 2025        â”‚  Dic 2025        â”‚ VariaciÃ³n      â”‚
â”‚                     â”‚  %, Casos, ğŸ˜ ğŸ˜Š  â”‚  %, Casos, ğŸ˜ ğŸ˜Š  â”‚ Î” Casos, Î”%, Î”ppâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nota fiscal invÃ¡lidaâ”‚ 25% â”‚ 3,710 â”‚ğŸ˜ 70% â”‚ 20% â”‚ 1,947 â”‚ğŸ˜ 65% â”‚ -1,763 â”‚...â”‚
â”‚                     â”‚     â”‚       â”‚ğŸ˜Š 0% â”‚     â”‚       â”‚ğŸ˜Š 0% â”‚        â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Columnas:**
1. **PatrÃ³n/Causa RaÃ­z:** Nombre descriptivo del patrÃ³n identificado
2. **Nov 2025:**
   - `%`: ProporciÃ³n del total de conversaciones muestreadas
   - `Casos`: Casos estimados
   - `Sentimiento`: ğŸ˜  FrustraciÃ³n % / ğŸ˜Š SatisfacciÃ³n %
3. **Dic 2025:** Mismas mÃ©tricas
4. **VariaciÃ³n:**
   - `Î” Casos`: VariaciÃ³n absoluta de casos
   - `Î” %`: VariaciÃ³n porcentual
   - `Î” Prop`: Cambio en puntos porcentuales de proporciÃ³n

### **Evidencia Cualitativa con Fechas**

```html
<div class="evidencia">
    <strong>Reactivaciones exitosas con nota fiscal vÃ¡lida</strong>
    <p>Vendedores que corrigieron su documentaciÃ³n...</p>
    
    <blockquote>
        <span class="case-id">Caso 413661025 (2025-11-02):</span>
        A representante Isa revisou a nota do item e confirmou...
    </blockquote>
</div>
```

**CaracterÃ­sticas:**
- âœ… Top 2 causas visibles por defecto
- âœ… Fecha de cada caso: `(YYYY-MM-DD)`
- âœ… BotÃ³n "Ver citas adicionales â–¼" para causas 3, 4+
- âœ… Cada cita incluye: CASE_ID, fecha, texto literal

### **Metadata de Cobertura**

```
ğŸ“Š Conversaciones analizadas: 58 casos (30 Nov + 28 Dic)
   Cobertura: 100% del incoming
```

**Por quÃ© importa:**
- Valida la representatividad del anÃ¡lisis
- Muestra transparencia en el sampling
- Indica si hay gaps de datos

### **Insight Principal**

```
ğŸ’¡ Insight Principal:
La reducciÃ³n de 5,105 casos (-34.4%) se explica principalmente por:
(1) Menos problemas de documentaciÃ³n invÃ¡lida (-1,763 casos)
(2) Menos denuncias de marca (-1,058 casos)
Sin embargo, los falsos positivos del sistema aumentaron proporcionalmente...
```

**Generado por:** AnÃ¡lisis LLM (Claude) sobre los datos comparativos

### **BotÃ³n Colapsable "Ver citas adicionales"**

**Por defecto:** Muestra solo top 2 causas (las de mayor impacto)

**Al expandir:**
- Muestra causas 3, 4 y adicionales
- Hasta 2 citas por causa adicional
- Mantiene el reporte compacto inicialmente

**JavaScript:**
```javascript
function toggleCitas(procesoid) {
    var elem = document.getElementById('citas_' + procesoid);
    var btn = document.getElementById('btn_' + procesoid);
    if (elem.style.display === 'none') {
        elem.style.display = 'block';
        btn.innerHTML = 'Ocultar citas adicionales â–²';
    } else {
        elem.style.display = 'none';
        btn.innerHTML = 'Ver citas adicionales â–¼';
    }
}
```

---

## ğŸ’¾ Formato JSON del AnÃ¡lisis Comparativo

### **Estructura del Archivo**

**UbicaciÃ³n:** `output/analisis_conversaciones_comparativo_claude_{site}_{commerce_group}_{p1_mes}_{p2_mes}.json`

**Ejemplo:** `analisis_conversaciones_comparativo_claude_mlb_moderaciones_2025-11_2025-12.json`

### **Schema JSON**

```json
{
  "PR - Propiedad intelectual": {
    "proceso": "PR - Propiedad intelectual",
    "commerce_group": "MODERACIONES",
    "site": "MLB",
    "periodo": "Nov-Dic 2025",
    "incoming_nov": 14839,
    "incoming_dic": 9734,
    "variacion_casos": -5105,
    "variacion_pct": -34.4,
    "conversaciones_nov": 30,
    "conversaciones_dic": 28,
    
    "causas_nov": [
      {
        "causa": "Nota fiscal invÃ¡lida o CNPJ no coincidente",
        "porcentaje": 25,
        "casos_estimados": 8,
        "descripcion": "Vendedores con nota fiscal...",
        "sentimiento": {
          "frustracion": 70,
          "satisfaccion": 0,
          "alivio": 0
        },
        "citas": [
          {
            "case_id": "413661025",
            "fecha": "2025-11-02",
            "texto": "A representante Isa revisou..."
          }
        ]
      }
    ],
    
    "causas_dic": [
      {
        "causa": "Nota fiscal invÃ¡lida o CNPJ no coincidente",
        "porcentaje": 20,
        "casos_estimados": 6,
        "descripcion": "...",
        "sentimiento": {
          "frustracion": 65,
          "satisfaccion": 0,
          "alivio": 0
        },
        "citas": [...]
      }
    ],
    
    "analisis_comparativo": {
      "insight_principal": "La reducciÃ³n de 5,105 casos...",
      "hallazgos_clave": [
        "Menos problemas de documentaciÃ³n invÃ¡lida (-1,763 casos)",
        "Falsos positivos aumentaron proporcionalmente (60% vs 50%)"
      ]
    }
  }
}
```

### **Campos Obligatorios**

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `proceso` | string | Nombre del proceso/elemento |
| `incoming_nov` | int | Incoming total Nov |
| `incoming_dic` | int | Incoming total Dic |
| `variacion_casos` | int | Î” casos (Dic - Nov) |
| `variacion_pct` | float | % variaciÃ³n |
| `conversaciones_nov` | int | Conversaciones analizadas Nov |
| `conversaciones_dic` | int | Conversaciones analizadas Dic |
| `causas_nov` | array | Causas del perÃ­odo Nov |
| `causas_dic` | array | Causas del perÃ­odo Dic |
| `analisis_comparativo.insight_principal` | string | Insight generado por LLM |

### **Estructura de Causa**

```json
{
  "causa": "Nombre descriptivo de la causa raÃ­z",
  "porcentaje": 25,
  "casos_estimados": 8,
  "descripcion": "ExplicaciÃ³n detallada...",
  "sentimiento": {
    "frustracion": 70,
    "satisfaccion": 0,
    "alivio": 0
  },
  "citas": [
    {
      "case_id": "413661025",
      "fecha": "2025-11-02",
      "texto": "Cita textual del caso..."
    }
  ]
}
```

**Validaciones:**
- âœ… `casos_estimados` = `round((porcentaje / 100) * total_conversaciones)` â† frecuencia real de la muestra, NO del incoming total
- âœ… Suma de `porcentaje` â‰ˆ 100% (Â±5% tolerancia)
- âœ… `sentimiento.frustracion + satisfaccion + alivio` â‰ˆ 100%
- âœ… MÃ­nimo 1 cita por causa (hasta 3 citas mÃ¡ximo)
- âœ… Formato fecha: `YYYY-MM-DD`

---

## ğŸ“‹ Tabla de Contenidos

1. [IntroducciÃ³n](#introducciÃ³n)
2. [Â¿Por quÃ© un Template Universal?](#por-quÃ©-un-template-universal)
3. [Template Universal v6.3.4](#template-universal-v634)
4. [Mejoras en v6.3.4](#mejoras-en-v634)
5. [AnÃ¡lisis Comparativo de Patrones](#anÃ¡lisis-comparativo-de-patrones-v634)
6. [Formato JSON del AnÃ¡lisis Comparativo](#formato-json-del-anÃ¡lisis-comparativo)
7. [CÃ³mo Generar el AnÃ¡lisis Comparativo](#cÃ³mo-generar-el-anÃ¡lisis-comparativo)
8. [Uso y Ejemplos](#uso-y-ejemplos)
9. [CaracterÃ­sticas TÃ©cnicas](#caracterÃ­sticas-tÃ©cnicas)
10. [MigraciÃ³n desde Golden Templates Antiguos](#migraciÃ³n-desde-golden-templates-antiguos)

---

## ğŸ“– IntroducciÃ³n

El **Golden Template Universal v6.2** es el **Ãºnico template oficial** para generar reportes de Contact Rate (CR) en Commerce. Este template unifica y supera todas las funcionalidades de los Golden Templates especÃ­ficos (PDD, PNR) que existÃ­an anteriormente.

**FilosofÃ­a:**
> Un template Ãºnico, completamente parametrizable, que genera reportes de calidad Golden Template para cualquier site, commerce group, perÃ­odo y dimensiÃ³n de anÃ¡lisis.

---

## ğŸ¯ Â¿Por quÃ© un Template Universal?

### **Problema con Golden Templates EspecÃ­ficos (v3.9 - v4.0)**

Antes existÃ­an **6 templates diferentes**:
- `generar_golden_pdd_mla.py`
- `generar_golden_pdd_mla_tipificacion.py`
- `generar_golden_pdd_mlb_tipificacion.py`
- `generar_golden_pnr_mlb.py`
- `generar_reporte_cr_universal_v6.py`

**âŒ Problemas:**
- DuplicaciÃ³n masiva de cÃ³digo (80-90% idÃ©ntico)
- Mantenimiento complejo (cambios en 6 lugares)
- ParÃ¡metros fijos (Nov-Dic 2025 hardcoded)
- Keywords manuales por idioma
- Inconsistencias entre templates
- Bugs propagados entre versiones

### **SoluciÃ³n: Template Universal v6.2**

**âœ… Ventajas:**
- **CÃ³digo Ãºnico:** 1 script = 1 punto de mantenimiento
- **ParametrizaciÃ³n completa:** Site, perÃ­odos, commerce group, dimensiones
- **Consistencia garantizada:** Todos los reportes usan la misma lÃ³gica
- **Features superiores:** LLM analysis, hard metrics, eventos dinÃ¡micos
- **MÃ¡s fÃ¡cil de evolucionar:** Nuevas features se agregan 1 sola vez

---

## ğŸš€ Template Universal v6.3.4

### **Archivo Oficial**

```bash
generar_reporte_cr_universal_v6.3.py
```

### **Estructura del Reporte**

```
1. Resumen Ejecutivo (3 bullets con evidencia)
2. Cards Ejecutivas (8) + GrÃ¡fico Semanal
3. Eventos Comerciales (si hay hard metrics)
4. Cuadros Cuantitativos por DimensiÃ³n
5. AnÃ¡lisis Comparativo de Patrones ENRIQUECIDO
   â”œâ”€ Insight principal (quÃ© explica la variaciÃ³n)
   â”œâ”€ Metadata (conversaciones, cobertura)
   â”œâ”€ Tabla comparativa con sentimiento Nov vs Dic
   â”œâ”€ Evidencia con fechas (top 2 causas)
   â””â”€ BotÃ³n "Ver mÃ¡s citas" (causas adicionales)
6. Footer TÃ©cnico Colapsable
```

---

## ğŸ†• Mejoras en v6.3.4

**VersiÃ³n 6.3.4 implementa 9 mejoras crÃ­ticas que hacen el sistema verdaderamente universal:**

### **1. âœ… DimensiÃ³n de Muestreo DinÃ¡mica** (CRÃTICO)
- Ya no asume que siempre se usa CDU
- Se adapta automÃ¡ticamente a la dimensiÃ³n solicitada (PROCESO, TIPIFICACION, etc.)
- Path de archivos dinÃ¡mico: `cuadro_{dimension}_{site}.csv`

### **2. âœ… BÃºsqueda Inteligente de CSVs** (CRÃTICO)
- Maneja nombres con caracteres especiales (/, -, espacios)
- Usa regex robusto para extraer perÃ­odos
- Normaliza nombres antes de buscar archivos

### **3. âœ… DivisiÃ³n de Citas por Fecha Real**
- Asigna cada cita al perÃ­odo correcto segÃºn su fecha
- Ya no divide 50-50 arbitrariamente
- Fallback inteligente si falta informaciÃ³n de fecha

### **4. âœ… ValidaciÃ³n de Coherencia**
- Detecta inconsistencias entre JSON y cuadros cuantitativos
- Usa valores por defecto si falta informaciÃ³n
- ContinÃºa generaciÃ³n con advertencias claras

### **5. âœ… Fechas DinÃ¡micas**
- Ya no hardcodea Nov-Dic en fechas por defecto
- Se adapta automÃ¡ticamente a los perÃ­odos solicitados
- DistribuciÃ³n inteligente entre P1 y P2

### **6. âœ… Insights Completos**
- No trunca informaciÃ³n a 150 caracteres
- Contexto adicional para variaciones pequeÃ±as
- Mejor comprensiÃ³n de patrones

### **7. âœ… Control de Errores Robusto**
- DiagnÃ³stico detallado cuando algo falla
- Identifica rÃ¡pidamente archivos faltantes
- El reporte continÃºa sin anÃ¡lisis comparativo si hay error

### **8. âœ… Path del Script Robusto**
- Importaciones mÃ¡s estables
- Funciona desde cualquier ubicaciÃ³n
- Evita duplicados en sys.path

### **9. âœ… Encoding UTF-8 para Windows**
- Soluciona UnicodeEncodeError en PowerShell
- Soporta emojis y caracteres Unicode
- Fallback graceful si el encoding falla

**Referencia completa:** [`docs/CHANGELOG_v6.3.4.md`](CHANGELOG_v6.3.4.md)

---

### **Uso BÃ¡sico**

```bash
python generar_reporte_cr_universal_v6.3.py \
    --site [SITE] \
    --p1-start [FECHA_INICIO_P1] \
    --p1-end [FECHA_FIN_P1] \
    --p2-start [FECHA_INICIO_P2] \
    --p2-end [FECHA_FIN_P2] \
    --commerce-group [GRUPO] \
    --aperturas [DIMENSIONES]
```

### **ParÃ¡metros Disponibles**

| ParÃ¡metro | DescripciÃ³n | Ejemplo | Obligatorio |
|-----------|-------------|---------|-------------|
| `--site` | Site a analizar | `MLA`, `MLB`, `MCO` | âœ… |
| `--p1-start` | Fecha inicio perÃ­odo 1 | `2025-11-01` | âœ… |
| `--p1-end` | Fecha fin perÃ­odo 1 | `2025-11-30` | âœ… |
| `--p2-start` | Fecha inicio perÃ­odo 2 | `2025-12-01` | âœ… |
| `--p2-end` | Fecha fin perÃ­odo 2 | `2025-12-31` | âœ… |
| `--commerce-group` | Commerce group | `PDD`, `PNR`, `PCF` | âœ… |
| `--aperturas` | Dimensiones (separadas por coma) | `PROCESO,CDU,TIPIFICACION` | âœ… |
| `--process-name` | Filtro opcional de proceso | `Arrepentimiento` | âŒ |
| `--output-dir` | Directorio de salida | `output/custom/` | âŒ |
| `--open-report` | Abrir reporte automÃ¡ticamente | (flag) | âŒ |
| `--skip-conversations` | Saltar anÃ¡lisis conversaciones | (flag) | âŒ |
| `--muestreo-dimension` | DimensiÃ³n para muestreo | `TIPIFICACION` | âŒ |

### **Dimensiones Soportadas**

El template soporta **7 dimensiones diferentes**:

1. **PROCESO** - AnÃ¡lisis por `PROCESS_NAME`
2. **CDU** - AnÃ¡lisis por Caso de Uso
3. **TIPIFICACION** - AnÃ¡lisis por `REASON_DETAIL_GROUP_REPORTING`
4. **ENVIRONMENT** - AnÃ¡lisis por ambiente (DS, FBM, FLEX, XD)
5. **SOLUTION_ID** - AnÃ¡lisis por tipo de soluciÃ³n
6. **CHANNEL_ID** - AnÃ¡lisis por canal de contacto
7. **SOURCE_ID** - AnÃ¡lisis por fuente (IVR, CHAT, FORM, etc.)

---

## ğŸ¬ CÃ³mo Generar el AnÃ¡lisis Comparativo

### **Flujo Completo (3 Pasos)**

#### **Paso 1: Exportar Conversaciones (--export-only)**

```bash
py generar_reporte_cr_universal_v6.3.py \
    --site MLB \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group MODERACIONES \
    --aperturas PROCESO,CDU \
    --export-only
```

**Resultado:**
```
output/
  â”œâ”€ conversaciones_PR_-_Propiedad_intelectual_mlb_202511.csv (30 Nov + 29 Dic)
  â”œâ”€ conversaciones_PR_-_TÃ©cnica_prohibida_mlb_202511.csv
  â””â”€ conversaciones_PR_-_ArtÃ­culos_prohibidos_mlb_202511.csv
```

**QuÃ© hace:**
- âœ… Ejecuta muestreo de conversaciones (30 por elemento-perÃ­odo)
- âœ… Exporta CSVs con `CASE_ID`, `CONTACT_DATE_ID`, `CONVERSATION_SUMMARY`
- âœ… NO genera HTML (solo preparaciÃ³n de datos)

---

#### **Paso 2: Analizar con Cursor AI (LLM)**

**A) Separar conversaciones por perÃ­odo**

Usar el script `temp_analisis_por_periodo.py` (o manualmente en Cursor):

```python
# Ejemplo simplificado
import pandas as pd

# Cargar CSV completo
df = pd.read_csv('output/conversaciones_PR_-_Propiedad_intelectual_mlb_202511.csv')

# Separar por perÃ­odo
df['month'] = pd.to_datetime(df['CONTACT_DATE_ID']).dt.month
df_nov = df[df['month'] == 11]
df_dic = df[df['month'] == 12]

# Exportar
df_nov.to_csv('temp_PR_Propiedad_intelectual_NOV.csv', index=False)
df_dic.to_csv('temp_PR_Propiedad_intelectual_DIC.csv', index=False)
```

**B) Prompt para Cursor AI**

```markdown
Analiza las siguientes conversaciones de [PROCESO] para [SITE] [MES]:

**Contexto:**
- Incoming Nov: 14,839 casos
- Incoming Dic: 9,734 casos
- VariaciÃ³n: -5,105 casos (-34.4%)

**CSV Nov:** [30 conversaciones]
**CSV Dic:** [28 conversaciones]

**Tarea:**
1. Identifica las causas raÃ­z principales (cobertura â‰¥80%)
2. Para cada causa:
   - Nombre descriptivo
   - Porcentaje del incoming
   - Casos estimados
   - DescripciÃ³n (1-2 lÃ­neas)
   - Sentimiento (% frustraciÃ³n, satisfacciÃ³n, alivio)
   - 1-3 citas textuales con CASE_ID y fecha
3. Genera insight principal comparando Nov vs Dic

**Output:** JSON estructurado segÃºn schema (ver secciÃ³n anterior)
```

**C) Guardar resultado**

```bash
output/analisis_conversaciones_comparativo_claude_mlb_moderaciones_2025-11_2025-12.json
```

---

#### **Paso 3: Regenerar Reporte Completo**

```bash
py generar_reporte_cr_universal_v6.3.py \
    --site MLB \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group MODERACIONES \
    --aperturas PROCESO,CDU \
    --open-report
```

**QuÃ© hace:**
- âœ… Detecta que existe `analisis_conversaciones_comparativo_claude_...json`
- âœ… Carga el anÃ¡lisis pre-generado
- âœ… Genera HTML completo con anÃ¡lisis comparativo enriquecido
- âœ… Abre reporte automÃ¡ticamente

**Resultado:**
```
output/reporte_cr_moderaciones_mlb_nov_dec_2025_v6.3.html
```

---

### **Flujo AutomÃ¡tico con Pre-verificaciÃ³n**

El script v6.3.4 implementa **pre-verificaciÃ³n automÃ¡tica**:

```python
# Dentro de generar_reporte_cr_universal_v6.3.py
analisis_json_name = f"analisis_conversaciones_comparativo_claude_{site}_{commerce_group}_{p1_mes}_{p2_mes}.json"
analisis_json_path = Path("output") / analisis_json_name

if analisis_json_path.exists():
    # âœ… AnÃ¡lisis ya existe â†’ Genera reporte directamente (1 paso)
    generar_html_completo()
else:
    # âš ï¸ AnÃ¡lisis no existe â†’ Exportar CSVs primero (usar --export-only)
    if args.export_only:
        exportar_csvs()
        print("[INFO] CSVs exportados. Siguiente paso: analizar con LLM")
    else:
        print("[ERROR] No se encontrÃ³ anÃ¡lisis comparativo. Ejecutar con --export-only primero")
```

**Beneficio:** Si el anÃ¡lisis ya existe, un solo comando regenera el reporte completo.

---

### **Script Helper: Mapeo de Fechas**

Para agregar fechas a citas ya existentes en el JSON:

```python
# temp_agregar_fechas_a_citas.py
import json
import pandas as pd
from pathlib import Path

# Cargar JSON
json_path = Path("output/analisis_conversaciones_comparativo_claude_mlb_moderaciones_2025-11_2025-12.json")
with open(json_path, 'r', encoding='utf-8') as f:
    data = json.load(f)

# Para cada proceso
for proceso_key, proceso_data in data.items():
    # Cargar CSVs del proceso
    csv_nov = Path(f"output/temp_{proceso_key}_NOV.csv")
    csv_dic = Path(f"output/temp_{proceso_key}_DIC.csv")
    
    df_nov = pd.read_csv(csv_nov)
    df_dic = pd.read_csv(csv_dic)
    
    # Mapear fechas a citas Nov
    for causa in proceso_data['causas_nov']:
        for cita in causa['citas']:
            case_id = cita['case_id']
            fecha = df_nov[df_nov['CAS_CASE_ID'] == case_id]['CONTACT_DATE_ID'].iloc[0]
            cita['fecha'] = pd.to_datetime(fecha).strftime('%Y-%m-%d')
    
    # Mapear fechas a citas Dic
    for causa in proceso_data['causas_dic']:
        for cita in causa['citas']:
            case_id = cita['case_id']
            fecha = df_dic[df_dic['CAS_CASE_ID'] == case_id]['CONTACT_DATE_ID'].iloc[0]
            cita['fecha'] = pd.to_datetime(fecha).strftime('%Y-%m-%d')

# Guardar JSON actualizado
with open(json_path, 'w', encoding='utf-8') as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

print(f"âœ… Fechas agregadas a {len(data)} procesos")
```

---

## ğŸ’¡ Uso y Ejemplos

### **Ejemplo 1: Reporte PDD MLA (reemplazo de Golden PDD MLA)**

**ANTES (deprecated):**
```bash
python generar_golden_pdd_mla_tipificacion.py
```

**AHORA (v6.3.4):**
```bash
python generar_reporte_cr_universal_v6.3.py \
    --site MLA \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group PDD \
    --aperturas TIPIFICACION \
    --open-report
```

**Output:** `output/reporte_cr_pdd_mla_nov_dec_2025_v6.3.html`

---

### **Ejemplo 2: Reporte PNR MLB (reemplazo de Golden PNR MLB)**

**ANTES (deprecated):**
```bash
python generar_golden_pnr_mlb.py
```

**AHORA (v6.3.4):**
```bash
python generar_reporte_cr_universal_v6.3.py \
    --site MLB \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group PNR \
    --aperturas TIPIFICACION \
    --open-report
```

---

### **Ejemplo 3: AnÃ¡lisis por MÃºltiples Dimensiones**

```bash
python generar_reporte_cr_universal_v6.3.py \
    --site MLA \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group PDD \
    --aperturas PROCESO,CDU,TIPIFICACION \
    --open-report
```

**Output:** Reporte con **3 tablas** (1 por dimensiÃ³n)

---

### **Ejemplo 4: AnÃ¡lisis con Filtro de Proceso**

```bash
python generar_reporte_cr_universal_v6.3.py \
    --site MLA \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group PDD \
    --aperturas TIPIFICACION \
    --process-name "Arrepentimiento" \
    --open-report
```

**Output:** Solo casos de "Arrepentimiento"

---

### **Ejemplo 5: AnÃ¡lisis Cross-Commerce Group**

```bash
# Analizar PCF Comprador (Post-Compra)
python generar_reporte_cr_universal_v6.3.py \
    --site MLA \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group "PCF_COMPRADOR" \
    --aperturas PROCESO,TIPIFICACION \
    --open-report
```

---

### **Ejemplo 6: Exportar CSVs para AnÃ¡lisis Manual**

```bash
# Paso 1: Exportar conversaciones
python generar_reporte_cr_universal_v6.3.py \
    --site MLB \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group MODERACIONES \
    --aperturas PROCESO,CDU \
    --export-only

# Paso 2: Analizar con Cursor AI (manual)
# Paso 3: Regenerar reporte completo
python generar_reporte_cr_universal_v6.3.py \
    --site MLB \
    --p1-start 2025-11-01 --p1-end 2025-11-30 \
    --p2-start 2025-12-01 --p2-end 2025-12-31 \
    --commerce-group MODERACIONES \
    --aperturas PROCESO,CDU \
    --open-report
```

---

## ğŸ”§ CaracterÃ­sticas TÃ©cnicas

### **1. Hard Metrics con Fallback AutomÃ¡tico**

```python
# Intenta cargar hard metrics
df_metrics_p1 = cargar_hard_metrics(site, year1, month1)
df_metrics_p2 = cargar_hard_metrics(site, year2, month2)

if df_metrics_p1 and df_metrics_p2:
    # âœ… Usa mÃ©tricas precalculadas (100% precisiÃ³n, 16x mÃ¡s rÃ¡pido)
    use_hard_metrics = True
else:
    # âš ï¸ Fallback: calcula en tiempo real sobre muestra
    use_hard_metrics = False
```

**Beneficios:**
- âœ… Reportes siempre funcionan (con o sin hard metrics)
- âœ… Performance Ã³ptimo cuando hard metrics disponibles
- âœ… Footer indica quÃ© mÃ©todo se usÃ³

**DocumentaciÃ³n:** `metrics/GUIA_USUARIO.md`

---

### **2. AnÃ¡lisis de Conversaciones con LLM (Claude)**

```python
# Carga anÃ¡lisis pre-generado de Claude (Cursor AI)
if os.path.exists('output/analisis_conversaciones_claude.json'):
    with open('output/analisis_conversaciones_claude.json') as f:
        analisis_claude = json.load(f)
    # âœ… Usa anÃ¡lisis de Claude: causas raÃ­z, frecuencia, sentimiento, citas
else:
    # âš ï¸ Fallback: exporta CSVs para anÃ¡lisis manual
    export_csv_for_manual_analysis()
```

**CaracterÃ­sticas del anÃ¡lisis LLM:**
- âœ… **Causas raÃ­z especÃ­ficas** (no genÃ©ricas)
- âœ… **Frecuencia/porcentaje** por causa
- âœ… **Citas textuales** con `CASE_ID`
- âœ… **Sentimiento** (frustraciÃ³n/satisfacciÃ³n)
- âœ… **Cobertura â‰¥80%** garantizada
- âœ… **Badges "DÃA PICO/TÃPICO"** para contexto

**Template de prompt:** `templates/prompt_analisis_conversaciones.md`

---

### **3. Eventos Comerciales DinÃ¡micos**

```python
# Carga eventos desde tabla oficial
eventos = obtener_eventos_comerciales(
    client=bq_client,
    site=site,
    periodo=periodo
)
# Fuente: WHOWNER.LK_MKP_PROMOTIONS_EVENT
```

**Ventajas vs hardcoded:**
- âœ… Fechas reales del calendario comercial
- âœ… Se actualiza automÃ¡ticamente
- âœ… Incluye eventos especÃ­ficos por site
- âœ… Rangos completos (fecha_inicio â†’ fecha_fin)

**DocumentaciÃ³n:** `metrics/eventos/FUENTE_EVENTOS.md`

---

### **4. Resumen Ejecutivo Estructurado**

```html
<div class="executive-summary">
    <h2>ğŸ“Š Resumen Ejecutivo</h2>
    <ul>
        <li>â€¢ CR pasÃ³ de X.XX pp a Y.YY pp (+Z.ZZ pp, â†‘W%)</li>
        <li>â€¢ Principal causa: [CAUSA] (+N casos, +P%)</li>
        <li>â€¢ Picos detectados: [FECHA] (evento X)</li>
    </ul>
</div>
```

**Regla:** 3 bullets mÃ¡ximo (pirÃ¡mide invertida)

---

### **5. Metadata TÃ©cnica Completa**

```html
<div class="metadata-footer" style="display:none">
    <h3>âš™ï¸ Metadata TÃ©cnica del Reporte</h3>
    
    <h4>ğŸ“‹ ConfiguraciÃ³n</h4>
    <ul>
        <li>Site: MLA | Commerce Group: PDD</li>
        <li>PerÃ­odos: 2025-11 vs 2025-12</li>
        <li>Dimensiones: TIPIFICACION</li>
    </ul>
    
    <h4>ğŸ“Š MÃ©tricas Calculadas</h4>
    <ul>
        <li>FÃ³rmula CR: (Incoming / Driver) Ã— 100</li>
        <li>Driver: Ã“rdenes totales (GLOBAL)</li>
        <li>Hard Metrics: âœ… ACTIVAS</li>
    </ul>
    
    <h4>ğŸ” Queries Ejecutadas</h4>
    <ol>
        <li><strong>Incoming P1:</strong> BT_CX_CONTACTS filtrado...</li>
        <li><strong>Drivers P1:</strong> BT_ORD_ORDERS globales...</li>
        <li><strong>Hard Metrics P1:</strong> Cargado desde Parquet...</li>
    </ol>
</div>
```

**Beneficio:** Trazabilidad completa del anÃ¡lisis

---

### **6. Regla del 80% (PriorizaciÃ³n AutomÃ¡tica)**

```python
# Identificar elementos que explican 80%+ de la variaciÃ³n
contribucion_acum = 0
elementos_priorizados = []

for elemento in elementos_ordenados:
    contribucion_acum += abs(elemento['delta_incoming']) / abs(delta_total)
    elementos_priorizados.append(elemento)
    
    if contribucion_acum >= 0.80:
        break

# Solo profundizar en elementos priorizados
for elemento in elementos_priorizados:
    analizar_conversaciones(elemento)
    detectar_picos(elemento)
```

**Beneficio:** Foco en lo que realmente importa

---

### **7. Peak Detection por Elemento**

```python
# Detectar picos para cada elemento priorizado (regla 80%)
for elemento in elementos_priorizados:
    picos = detectar_picos_temporales(
        df=df_elemento,
        threshold_multiplier=1.5
    )
    
    if len(picos) > 0:
        # Muestreo ponderado: 70% casos de dÃ­as pico + 30% resto
        muestrar_conversaciones(elemento, picos)
```

**Template SQL:** `sql/templates/peak_detection_template.sql`

---

### **8. Estructura HTML Golden Template v6.3.4**

```html
<!-- 1. Header -->
<div class="header">
    <h1>Reporte CR [COMMERCE_GROUP] [SITE]</h1>
    <p>[P1] vs [P2]</p>
</div>

<!-- 2. Resumen Ejecutivo (3 bullets con evidencia cualitativa) -->
<div class="executive-summary">
    <ul>
        <li>â€¢ CR empeorÃ³/mejorÃ³ +X.XX pp (+Y%) | Nov: X.XX pp â†’ Dic: Y.YY pp</li>
        <li>â€¢ [ELEMENTO] lidera (X% contrib, +Y casos) | Causa: [CAUSA] (Z% casos) - [DESC]</li>
        <li>â€¢ [ELEMENTO_2] muestra mayor crecimiento/reducciÃ³n (+X%) | Causa crÃ­tica: [CAUSA]</li>
    </ul>
</div>

<!-- 3. Cards Ejecutivas (8 cards) -->
<div class="cards-container">
    <!-- Incoming P1, P2, Var | Driver P1, P2 | CR P1, P2, Var -->
</div>

<!-- 4. GrÃ¡fico Semanal (14+ semanas) -->
<div class="chart-container">
    <canvas id="weeklyChart"></canvas>
</div>

<!-- 5. Eventos Comerciales (si hard metrics disponibles) -->
<div class="eventos-table">...</div>

<!-- 6. Tablas Cuantitativas (1 por dimensiÃ³n) -->
<table class="data-table">
    <!-- PROCESO, CDU, TIPIFICACION, etc. -->
</table>

<!-- 7. ANÃLISIS COMPARATIVO ENRIQUECIDO (v6.3.4) â­ -->
<div class="section">
    <h2>ğŸ” AnÃ¡lisis Comparativo de Patrones por PerÃ­odo</h2>
    
    <!-- Por cada proceso priorizado -->
    <div class="proceso-analisis">
        <h3>ğŸ”¹ [PROCESO]</h3>
        <p>ğŸ“Š Conversaciones: X casos (Y Nov + Z Dic) | Cobertura: W%</p>
        
        <!-- Insight principal -->
        <div class="insight">
            <strong>ğŸ’¡ Insight Principal:</strong>
            <p>[Texto generado por LLM explicando quÃ© cambiÃ³ y por quÃ©]</p>
        </div>
        
        <!-- Tabla comparativa con sentimiento -->
        <table>
            <thead>
                <tr>
                    <th>PatrÃ³n/Causa</th>
                    <th colspan="3">Nov 2025</th>
                    <th colspan="3">Dic 2025</th>
                    <th>Var</th>
                </tr>
                <tr>
                    <th></th>
                    <th>%</th><th>Casos</th><th>Sentimiento</th>
                    <th>%</th><th>Casos</th><th>Sentimiento</th>
                    <th>Î” Casos</th><th>Î” %</th><th>Î” pp</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Nota fiscal invÃ¡lida</td>
                    <td>25%</td><td>3,710</td><td>ğŸ˜ 70% ğŸ˜Š0%</td>
                    <td>20%</td><td>1,947</td><td>ğŸ˜ 65% ğŸ˜Š0%</td>
                    <td>-1,763</td><td>-47.5%</td><td>-5pp</td>
                </tr>
            </tbody>
        </table>
        
        <!-- Evidencia cualitativa con fechas -->
        <div class="evidencia">
            <h4>ğŸ“Œ Evidencia Cualitativa con Citas</h4>
            
            <!-- Top 2 causas (siempre visibles) -->
            <div class="cita-card">
                <strong>Reactivaciones exitosas...</strong>
                <p>DescripciÃ³n de la causa</p>
                <blockquote>
                    <span class="case-id">Caso 413661025 (2025-11-02):</span>
                    Texto literal de la conversaciÃ³n...
                </blockquote>
            </div>
            
            <!-- BotÃ³n colapsable para mÃ¡s citas -->
            <button onclick="toggleCitas('proceso_id')">
                Ver citas adicionales â–¼
            </button>
            
            <div id="citas_proceso_id" style="display:none">
                <!-- Causas 3, 4, etc. -->
            </div>
        </div>
    </div>
</div>

<!-- 8. Metadata TÃ©cnica (collapsible) -->
<div class="footer-container">
    <button class="footer-toggle" onclick="toggleFooter()">
        ğŸ“‹ Metadata TÃ©cnica del Reporte v6.3.4
    </button>
    <div class="footer-content" id="footerContent">
        <!-- ConfiguraciÃ³n, mÃ©tricas, queries ejecutadas -->
    </div>
</div>
```

**EvoluciÃ³n de versiones:**
- **v6.2:** AnÃ¡lisis comparativo bÃ¡sico
- **v6.3.2:** AnÃ¡lisis enriquecido con sentimiento + fechas + botÃ³n colapsable
- **v6.3.4:** Sistema verdaderamente universal - se adapta a cualquier dimensiÃ³n, perÃ­odo y commerce group

---

## ğŸ¨ Colores por Commerce Group

| Commerce Group | Color Primario | Hex | Uso |
|----------------|----------------|-----|-----|
| PDD | Rojo | `#f44336` | Producto DaÃ±ado/Defectuoso |
| PNR | Naranja | `#ff9800` | Producto No Recibido |
| PCF Comprador | Verde | `#00a650` | Post-Compra Comprador |
| PCF Vendedor | Verde Oscuro | `#008040` | Post-Compra Vendedor |
| Marketplace | Azul | `#2196f3` | Commerce Groups Marketplace |
| Shipping | Morado | `#9c27b0` | ME DistribuciÃ³n, PreDespacho |

---

## ğŸ”„ MigraciÃ³n desde Golden Templates Antiguos

### **Tabla de Equivalencias**

| Golden Template Antiguo | Comando Equivalente v6.3.4 |
|-------------------------|--------------------------|
| `generar_golden_pdd_mla.py` | `--site MLA --commerce-group PDD --aperturas TIPIFICACION` |
| `generar_golden_pdd_mla_tipificacion.py` | `--site MLA --commerce-group PDD --aperturas TIPIFICACION` |
| `generar_golden_pdd_mlb_tipificacion.py` | `--site MLB --commerce-group PDD --aperturas TIPIFICACION` |
| `generar_golden_pnr_mlb.py` | `--site MLB --commerce-group PNR --aperturas TIPIFICACION` |
| `generar_reporte_cr_universal_v6.py` | `generar_reporte_cr_universal_v6.3.py` (v6.3.4) |

---

### **Scripts Wrapper (Opcional)**

Si necesitas mantener comandos simples tipo "Golden Template", puedes crear wrappers:

**Ejemplo: `ejemplos/ejecutar_reporte_pdd_mla.ps1`**

```powershell
# Golden Template PDD MLA - Wrapper para v6.3.4
$p1_start = "2025-11-01"
$p1_end = "2025-11-30"
$p2_start = "2025-12-01"
$p2_end = "2025-12-31"

python generar_reporte_cr_universal_v6.3.py `
    --site MLA `
    --p1-start $p1_start --p1-end $p1_end `
    --p2-start $p2_start --p2-end $p2_end `
    --commerce-group PDD `
    --aperturas TIPIFICACION `
    --open-report

Write-Host "âœ… Reporte PDD MLA generado exitosamente"
```

**Uso:**
```powershell
.\ejemplos\ejecutar_reporte_pdd_mla.ps1
```

---

## ğŸ“š DocumentaciÃ³n Relacionada

### **Sistema de Hard Metrics**
- â­ **`metrics/GUIA_USUARIO.md`** - GuÃ­a prÃ¡ctica de hard metrics
- **`metrics/eventos/FUENTE_EVENTOS.md`** - Tabla oficial de eventos
- **`metrics/eventos/CUANDO_REGENERAR.md`** - CuÃ¡ndo regenerar mÃ©tricas

### **AnÃ¡lisis de Conversaciones**
- **`templates/prompt_analisis_conversaciones.md`** - Prompt LLM estructurado
- **`sql/templates/muestreo_unificado_template.sql`** - Query de muestreo

### **Estructura de Reportes**
- **`docs/REPORT_STRUCTURE.md`** - Estructura HTML oficial
- **`docs/COMMERCE_GROUPS_REFERENCE.md`** - Commerce groups completos

### **Reglas CrÃ­ticas**
- **`.cursorrules`** - Reglas obligatorias del repositorio
- **`docs/GUIDELINES.md`** - Mejores prÃ¡cticas

---

## ğŸ¯ Mejoras Futuras

**Roadmap v6.5+:**
- [ ] AnÃ¡lisis de verticales y dominios (PDD/PNR)
- [ ] Soporte para anÃ¡lisis multi-site en un solo reporte
- [ ] IntegraciÃ³n directa con API de Claude para anÃ¡lisis on-demand
- [ ] Export a PDF ademÃ¡s de HTML
- [ ] Dashboard interactivo con filtros dinÃ¡micos
- [ ] AnÃ¡lisis de tendencias (comparaciÃ³n 3+ meses)

**Completado en v6.3.4:**
- [x] Sistema verdaderamente universal (cualquier dimensiÃ³n/perÃ­odo/commerce group)
- [x] DimensiÃ³n de muestreo dinÃ¡mica
- [x] BÃºsqueda inteligente de CSVs con caracteres especiales
- [x] DivisiÃ³n de citas por fecha real (no 50-50)
- [x] ValidaciÃ³n de coherencia JSON vs cuadros
- [x] Fechas dinÃ¡micas (no hardcoded Nov-Dic)
- [x] Insights completos sin truncar
- [x] Control de errores robusto con diagnÃ³stico
- [x] Encoding UTF-8 para Windows PowerShell
- [x] 100% backward compatible

---

## ğŸ“ Soporte

**Â¿Necesitas ayuda?**

1. **Consulta la documentaciÃ³n:**
   - `README.md` (raÃ­z del repositorio)
   - `metrics/GUIA_USUARIO.md` (hard metrics)
   - `docs/REPORT_STRUCTURE.md` (estructura HTML)
   - **`docs/GOLDEN_TEMPLATES.md`** (este documento - guÃ­a completa v6.3.2)

2. **Revisa ejemplos:**
   - SecciÃ³n "Uso y Ejemplos" en este documento
   - `ejemplos/` (scripts wrapper)

3. **Contacta al equipo:**
   - CR Analytics Team
   - Mantenedor del repositorio

---

**Ãšltima actualizaciÃ³n:** 2 de Febrero de 2026  
**VersiÃ³n:** 6.3.4  
**Status:** âœ… ÃšNICO TEMPLATE OFICIAL - VERSIÃ“N MÃS ROBUSTA Y UNIVERSAL  
**Reemplazo de:** Golden Templates v3.9, v4.0, v6.0-v6.3.2 (archivados en `_archived_templates/`)  
**Changelog completo:** [`docs/CHANGELOG_v6.3.4.md`](CHANGELOG_v6.3.4.md)
