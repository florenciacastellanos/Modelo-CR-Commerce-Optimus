-- Debug: Verificar disponibilidad de ORD_CLOSED_DT para GENERALES_COMPRA en MEC
SELECT 
    CASE WHEN pp.ORD_CLOSED_DT IS NOT NULL THEN 'CON_FECHA_CIERRE' ELSE 'SIN_FECHA_CIERRE' END as estado,
    c.PROCESS_NAME,
    COUNT(DISTINCT c.CAS_CASE_ID) as casos
FROM `meli-bi-data.WHOWNER.BT_CX_CONTACTS` c
LEFT JOIN `meli-bi-data.WHOWNER.DM_CX_POST_PURCHASE` pp 
    ON c.CLA_CLAIM_ID = pp.CLA_CLAIM_ID
WHERE c.SIT_SITE_ID = 'MEC'
    AND c.CONTACT_DATE_ID BETWEEN '2025-12-01' AND '2026-01-31'
    AND COALESCE(c.FLAG_EXCLUDE_NUMERATOR_CR, 0) = 0
    AND COALESCE(c.QUEUE_ID, 0) NOT IN (2131, 230, 1102, 1241, 2075, 2294, 2295)
    AND COALESCE(c.CI_REASON_ID, 0) NOT IN (2592, 6588, 10068, 2701, 10048)
    AND (c.PROCESS_PROBLEMATIC_REPORTING LIKE '%Compra%' AND c.PROCESS_GROUP_ECOMMERCE = 'Comprador')
GROUP BY 1, 2
ORDER BY 1, casos DESC
